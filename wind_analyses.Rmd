---
title: "wind_diagrams"
author: "Amieroh Abrahams"
date: "01 August 2019"
output: html_document
---

Loading the Wind data. The wind dataset was supplied by the SAWS in .text format. Wind data was provided for the sites closes to the requested site as wind data may not be available for the 6 study sites in this research.  The wind direction was collected every 2 hours and by using the circular function we calcuated the daily wind direction and mean speed. There is a numerically large gap between 360 and 2 where as in degrees its not as large. The circular mean function returns the mean direction of a vector of circular data. https://cran.r-project.org/web/packages/circular/circular.pdf (Pg 130). The circular function creates circular objects around the wind direction. 

```{r}
wind_1 <- read.delim("Data/Wind_data/wind_data.txt(SAWS)/wind1/wind1.txt", na.strings = "", 
                     col.names = c("station_number", "station_name", "date", "hour", "sub", "speed", "dir"))

wind_2 <- read.delim("Data/Wind_data/wind_data.txt(SAWS)/wind2/wind2.txt", na.strings = "",
                     col.names = c("station_number", "station_name", "date", "hour", "sub" ,"speed", "dir"))

wind_3 <- read.delim("Data/Wind_data/wind_data.txt(SAWS)/wind3/wind3.txt", na.strings = "",
                     col.names = c("station_number", "station_name", "date", "hour", "sub" ,"speed", "dir"))

# Slecting the important columns for each of the datasets
wind_fix <- function(df){
wind <- df %>% 
  select(station_name, date, hour, dir, speed) %>%  #column names
  mutate(date = as.Date(as.character(date)),
         hour = as.numeric(as.character(hour)), 
         dir = as.numeric(as.character(dir)),
         speed = as.numeric(as.character(speed)))
}
# RWS: We can see when we force the values to be numeric that there are some non-numeric values in the base data
wind_1 <- wind_fix(df = wind_1)
wind_2 <- wind_fix(df = wind_2)
wind_3 <- wind_fix(df = wind_3)

## Renaming the sites within the wind datasets to match the name of the sites at which seawater temperature was collected
## The wind data was obtained from the SAWS and the wind stations used were the closes stations to which temperature was collected

renaming_sites_1 <- function(df) {
  sites <- df %>%
      # RWS: An alternative way to replace values without having to use multiple ifelse() statements
      mutate(temp_sites = case_when(station_name == "CAPE TOWN TABLE BAY" ~ "Sea Point",
                                    station_name == "CAPE TOWN - ROYAL YACHT CLUB" ~ "Sea Point",
                                    station_name  == "PORT NOLLOTH" ~"Port Nolloth",
                                    station_name  == "CAPE TOWN SLANGKOP" ~ "Hout Bay",
                                    station_name  == "LAMBERTSBAAI NORTIER" ~ "Lamberts Bay",
                                    station_name  == "LANGEBAANWEG AWS" ~ "Saldanha Bay"))
  return(sites)
}


wind_sitesmatched_1 <-  renaming_sites_1(df = wind_1)
wind_sitesmatched_2 <-  renaming_sites_1(df = wind_2)
wind_sitesmatched_3 <-  renaming_sites_1(df = wind_3)
wind_data <- rbind(wind_sitesmatched_3,wind_sitesmatched_2,wind_sitesmatched_1)
save(wind_data, file = "Data/wind_data.RData")

# # RWS: You should never be removing values by specific call like this
#   # Rather you should be able to use some sort of conditional to screen out unwanted values
# wind_sitesmatched_1 <- wind_sitesmatched_1[-c(121352, 121353, 379892, 379893, 609324, 609325, 843506, 843507, 1014585), ]
# renaming_sites_2 <- function(df) {
#   sites <- df %>%
#     mutate(temp_sites = ifelse(station_name %in% c("ROBBENEILAND"), "Koeberg Basin",        
#                            ifelse(station_name %in% c("GEELBEK"), "Yzerfontein",
#                                 ifelse(station_name %in% c("DASSEN ISLAND"), "Dassen Island",
#                                        ifelse(station_name %in% c("ATLANTIS"), "Koeberg Basin","Error")))))
#   return(sites)
# }
# 
# wind_sitesmatched_2 <-  renaming_sites_2(df = wind_2)
# wind_sitesmatched_2 <- wind_sitesmatched_2[-c(228372, 228373, 313441, 313442, 364881, 364882, 557392), ] 
# renaming_sites_3 <- function(df) {
#   sites <- df %>%
#     mutate(temp_sites = ifelse(station_name %in% c("CAPE TOWN SLANGKOP"), "Kommetjie",  
#                            ifelse(station_name %in% c("CAPE TOWN - ROYAL YACHT CLUB"), "Sea Point",
#                            ifelse(station_name %in% c("CAPE TOWN TABLE BAY"), "Sea Point","Error"))))
#   return(sites)
# }
# 
# wind_sitesmatched_3 <-  renaming_sites_3(df = wind_3)
# wind_sitesmatched_3 <- wind_sitesmatched_3[-c(119317, 119318, 196551, 196552, 346759), ] 
### CAPE TOWN SLANGKOP may be used for Kommetjie and for Houtbay
# wind_3_HoutBay <- wind_3 %>% 
#   filter(station_name == "CAPE TOWN SLANGKOP") %>% 
#   mutate(temp_sites = ifelse(station_name %in% c("CAPE TOWN SLANGKOP"), "Hout Bay","Error"))
# wind_data <- rbind(wind_3_HoutBay,wind_sitesmatched_3,wind_sitesmatched_2,wind_sitesmatched_1)
# wind_data <- wind_data %>% 
#   na.omit()
# 
# wind_data <- wind_data %>% 
#   # mutate(date = as.Date(date)) %>%  
#   group_by(date, hour, temp_sites) 
# 
# # write.csv(wind_data, file = "Data_P1/wind_data.csv", row.names = T)
# # save(wind_data, file = "Data_P1/wind_data.RData")

# load("Data_P1/insitu_wind.RData")
# 
# test1 <- insitu_wind %>% 
#   mutate(lat = case_when(site == "Port Nolloth" ~ "-29.25241",
#                                     site == "Saldanha Bay" ~ "-33.01054",
#                                     site  == "Yzerfontein" ~ "-33.36068",
#                                     site  == "Kommetjie" ~ "-34.13667",
#                                     site  == "Lamberts Bay" ~ "-32.09185",
#                                     site  == "Sea Point" ~ "-33.91847"))
# 
# test <- test1 %>% 
#   mutate(lon = case_when(site == "Port Nolloth" ~ "16.86710",
#                                     site == "Saldanha Bay" ~ "17.95063",
#                                     site  == "Yzerfontein" ~ "18.15731",
#                                     site  == "Kommetjie" ~ "18.32674",
#                                     site  == "Lamberts Bay" ~ "18.30262",
#                                     site  == "Sea Point" ~ "18.38217"))
# 
# test_final <- test %>% 
#   select(date,lat,lon,dir_circ, mean_speed) %>% 
#   dplyr::rename(speed = mean_speed) %>% 
#   dplyr::rename(dir = dir_circ)

# Loading the wind data
library(tidyverse)
library(circular)

# wind_data <- read_csv("wind_data.csv", col_types = cols(X1 = col_number(), date = col_character(), dir = col_number(), hour = col_number(),  speed = col_number())) # Dataset too large for Github but better data at line 638

# wind_data <- read_csv("Data_P1/wind_data.csv")
selected_sites <- c("Port Nolloth", "Lamberts Bay", "Sea Point", "Saldanha Bay", "Hout Bay") 

wind_daily <- wind_data %>%
  # ungroup() %>%
  # mutate(date = as.Date(date))%>%
  dplyr::group_by(temp_sites, date) %>%
  filter(temp_sites %in% selected_sites) %>% 
  dplyr::summarise(dir_circ = round(mean.circular(circular(dir, units = "degrees")),2),
                   mean_speed = round(mean(speed),2)) 


# save(wind_daily, file = "Data/wind_daily.RData")
# # Loading in the daily wind data

# Loading the subsetted wind data created from the text files above 
load("Data/wind_daily.RData") 
```

# Matching
  Matching the wind data with the temperature data using the match function
  
```{r}
match_func <- function(df){
  match <- SACTN_US  %>%  
  left_join(df, by = c("site", "date")) %>% 
  na.trim()
  return(match)
}

wind_daily <- wind_daily %>% 
  dplyr::rename(site = temp_sites)

wind_match <- match_func(df = wind_daily) 
# save(wind_match, file = "Data/wind_match.RData")

library(openair)
print(
with(wind_match,
     windRose(data_frame(ws=mean_speed, wd=dir_circ, 
                         date=date, station=factor(site)),

              paddle=FALSE, type="station", width=2))
)
# png("Figures/wind.png", width = 8, height = 5, pointsize = 6)
?windRose
# ?plot
```

## Wind rose plots

```{r}
# Loading in the matched wind data
load("Data/wind_match.RData")

wind_match <- wind_match %>% 
  drop_na()

wave_daily_renamed <- wind_match %>% 
  dplyr::rename(spd = mean_speed) %>%
  dplyr::rename(dir = dir_circ) 
source("Functions/wind.rose.R")
p.wr2 <- plot.windrose(data = wave_daily_renamed,
              spd = "spd",
              dir = "dir")
p.wr3 <- p.wr2 + facet_wrap(.~ site, ncol = 2, nrow = "") +
  theme(strip.text.x = element_text(size = 25))
p.wr3  # Change colours and remove the NA values
```










