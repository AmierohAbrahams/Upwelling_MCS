---
title: "upwell_IDX"
author: "Amieroh Abrahams"
date: "08 August 2019"
output: html_document
---

# Upwelling

Upwelling is primarily caused by alongshore, equator ward winds. These winds are caused by cross-shore atmospheric pressure gradients, and these gradients occur predominantly during heating periods. Upwelling is defined as the process whereby cold, nutrient rich, high concentrated CO2, low pH, and low oxygenated waters are pushed to the surface as a result of alongshore winds interacting with the earth’s rotation.

# Upwelling indeces
  # Determining upwelling index from wind data (SAWS)
  # Index Equation from Fielding & Davis 1989 paper

$$ UpwellingIndex = μ{(Cosθ − 160)}$$

In this equation μ represents the wind speed (m/s) and θ represents the wind direction which is measured in degrees. The 160 degrees is used as this refers to the angle of the coastline. This equation is largely dependant on wind speed and direction data in order to determing the intensity of the upwelling event. Wind data were obtained daily from the South African Weather Service (SAWS). This wind data was then matched to the date at which temperature were collected. With this data the upwelling index was determined.

# libraries

```{r}
library(tidyverse)
library(ggplot2)
library(circular)
# devtools::install_github("robwschlegel/coastR")
library(coastR)
library(gridExtra)
library(dplyr)
library(geosphere)
```

# Steps
  - Use the circular function 
  - Determine daily wind data obtained from 3hr intervals

```{r}
# wind_1 <- read.delim("Data/Wind_data/wind_data.txt(SAWS)/wind1/wind1.txt", na.strings = "",
#                      col.names = c("station_number", "station_name", "date", "hour", "sub", "speed", "dir"))
# 
# wind_2 <- read.delim("Data/Wind_data/wind_data.txt(SAWS)/wind2/wind2.txt", na.strings = "",
#                      col.names = c("station_number", "station_name", "date", "hour", "sub" ,"speed", "dir"))
# 
# wind_3 <- read.delim("Data/Wind_data/wind_data.txt(SAWS)/wind3/wind3.txt", na.strings = "",
#                      col.names = c("station_number", "station_name", "date", "hour", "sub" ,"speed", "dir"))
# 
# # Slecting the important columns for each of the datasets
# wind_fix <- function(df){
# wind <- df %>%
#   select(station_name, date, hour, dir, speed) %>%  #column names
#   mutate(date = as.Date(as.character(date)),
#          hour = as.numeric(as.character(hour)),
#          dir = as.numeric(as.character(dir)),
#          speed = as.numeric(as.character(speed)))
# }
# 
# wind_1 <- wind_fix(df = wind_1)
# wind_2 <- wind_fix(df = wind_2)
# wind_3 <- wind_fix(df = wind_3)
# 
# ## Renaming the sites within the wind datasets to match the name of the sites at which seawater temperature was collected
# ## The wind data was obtained from the SAWS and the wind stations used were the closes stations to which temperature was collected
# 
# renaming_sites_1 <- function(df) {
#   sites <- df %>%
#       mutate(temp_sites = case_when(station_name == "CAPE TOWN TABLE BAY" ~ "Sea Point",
#                                     station_name == "CAPE TOWN - ROYAL YACHT CLUB" ~ "Sea Point",
#                                     station_name  == "PORT NOLLOTH" ~"Port Nolloth",
#                                     station_name  == "CAPE TOWN SLANGKOP" ~ "Hout Bay",
#                                     station_name  == "LAMBERTSBAAI NORTIER" ~ "Lamberts Bay",
#                                     station_name  == "LANGEBAANWEG AWS" ~ "Saldanha Bay"))
#   return(sites)
# }
# 
# 
# wind_sitesmatched_1 <-  renaming_sites_1(df = wind_1)
# wind_sitesmatched_2 <-  renaming_sites_1(df = wind_2)
# wind_sitesmatched_3 <-  renaming_sites_1(df = wind_3)
# wind_data <- rbind(wind_sitesmatched_3,wind_sitesmatched_2,wind_sitesmatched_1)
# # save(wind_data, file = "Data/wind_data.RData")
# 
# load("Data/wind_data.RData")
# selected_sites <- c("Port Nolloth", "Lamberts Bay", "Sea Point", "Saldanha Bay", "Hout Bay")
# 
# wind_daily <- wind_data %>%
#   # ungroup() %>%
#   # mutate(date = as.Date(date))%>%
#   dplyr::group_by(temp_sites, date) %>%
#   filter(temp_sites %in% selected_sites) %>%
#   dplyr::summarise(dir_circ = round(mean.circular(circular(dir, units = "degrees")),2),
#                    mean_speed = round(mean(speed),2))
# #save(wind_daily, file = "Data/wind_daily.RData")
```

# Load wind

```{r}
load("Data/wind_daily.RData") 
wind_daily <- wind_daily %>% 
  dplyr::rename(sites = temp_sites)
```

# Determining the angle perpendicular to the coastline and plotting it

```{r}
south_africa_away_wide <- transects(site_list_sub, spread = 30)

world_map <- ggplot() + 
  borders(fill = "grey40", colour = "black")

# Create titles
titles <- c("Shore-normal", "Islands")

# Plotting function
plot_sites <- function(site_list, buffer, title_choice, dist){
  
  # Find the point 200 km from the site manually to pass to ggplot
  heading2 <- data.frame(geosphere::destPoint(p = select(site_list, lon, lat),  
                                              b = site_list$heading, d = dist))
  
  # Add the new coordinates tot he site list
  site_list <- site_list %>% 
    mutate(lon_dest = heading2$lon,
           lat_dest = heading2$lat)
  
  # Visualise
  world_map +
    geom_segment(data = site_list, colour = "red4", 
                 aes(x = lon, y = lat, xend = lon_dest, yend = lat_dest)) +
    geom_point(data = site_list, size = 3, colour = "black", aes(x = lon, y = lat)) +
    geom_point(data = site_list, size = 3, colour = "red", aes(x = lon_dest, y = lat_dest)) +
    coord_cartesian(xlim = c(min(site_list$lon - buffer), 
                             max(site_list$lon + buffer)),
                    ylim = c(min(site_list$lat - buffer), 
                             max(site_list$lat + buffer))) +
    labs(x = "", y = "", colour = "Site\norder") +
    ggtitle(titles[title_choice])
}

south_africa_away <- plot_sites(south_africa_away_wide, 1, 1, 100000)
```

You can then use the exceedence() function from heatwaveR to check for consecutive numbers of days at or above whatever the UI value is meant to be at 
Sounds good. Good luck! 

```{r}

wind_angle <- wind_daily %>% 
  dplyr::rename(site = sites) %>% 
  left_join(south_africa_away_wide[,c(2,21)], by = "site") %>% 
  dplyr::rename(coast_angle = heading) %>% 
  mutate(ui.saws = mean_speed * (cos(dir_circ - coast_angle))) %>% 
  drop_na

# index <- wind_UI %>% 
#   group_by(sites) %>% 
#   select("date", "ui.saws") %>% 
#   mutate(saws.condition = ifelse(ui.saws < 12.5, "upwelling"))
```




# Visualisiing the data

```{r}
plot1 <- ggplot(data = index, aes(x = date, y = ui.saws)) +
  geom_line() +
  facet_wrap(~sites, ncol = 1) +
  geom_area(aes( fill = saws.condition)) +
  theme_grey()
plot1
```

# MCS and upwelling indeces plot

```{r}
match_func <- function(df){
  match <- SACTN_MCS_clims  %>% 
  left_join(df, by = c("site", "t")) %>% 
  na.trim()
  return(match)
}

index <- index %>% 
  dplyr::rename(site = sites) %>% 
  dplyr::rename(t = date)

match <- match_func(df = index)

upwell_MCS <- ggplot(data = match, aes(x = t, y = ui.saws)) +
  geom_line() +
  geom_point(data = filter(match, event == TRUE), colour = "navy") +
  geom_rug(data = filter(match, saws.condition == "upwelling"), sides = "b") +
  scale_x_date(expand = c(0, 0)) +
  facet_wrap(~site, ncol = 1) +
  theme_grey() +
  labs(y = "Temperature (°C)", x = NULL)
upwell_MCS

```















