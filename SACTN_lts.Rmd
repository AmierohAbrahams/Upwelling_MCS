---
title: "long_ts"
author: "Amieroh Abrahams"
date: "31 July 2019"
output: html_document
---

# Detectig frequency and intensity of upwelling events - Use MHW algorithm 
  Long time series of 30years
  Use OISST 
  Match this up with MCS occuring in the region
  Paper 1 (Local paper)
  Upwelling: 30th percentiles within EBUS
  

```{r prelim_opts, echo=FALSE}
knitr::opts_chunk$set(
  comment = "R>",
  warning = FALSE,
  message = FALSE 
)

library(tidyverse)
library(plyr)
library(lubridate)
library(ggpubr)
library(zoo)
library(data.table)
library(heatwaveR)
library(viridis)
library(gridExtra)
library(fossil)
library(plyr) # Never load plyr when also loading the tidyverse. It causes a lot of conflicts.
library(stringr)
library(doMC); doMC::registerDoMC(cores = 4)
library(fasttime)
library(xtable)
library(ggpubr)
library(ggpubr); theme_set(theme_pubr())# library(devtools)

```

# Loading the data and finding a 30year time series

```{r}
load("~/Documents/Masters_2019/Upwelling_MCS/Data/SACTN_daily_v4.2.RData")
load("~/Documents/Masters_2019/Upwelling_MCS/Data/site_list_v4.2.RData")

site_list_sub <- site_list %>%
  filter(coast == "wc") %>%
  filter(length > 10950) 
# save(site_list_sub, file = "site_list_sub.Rdata")


SACTN_US <- SACTN_daily_v4.2 %>%
  left_join(site_list[,c(4,13)], by = "index") %>%
  filter(index %in% site_list_sub$index) %>%
  separate(index, into = c("site", "src"), sep = "/", remove = FALSE)

# save(SACTN_US, file = "Data/SACTN_US.RData")
```

# Long time series in_situ temperature
  First creating datasets for each region
  Now I determine the frequency and intensity of MCS using the MHW algorithm
  
```{r}

filter_SACTN <- function(df){
  SACTN_PN <- SACTN_US %>%
  filter(site == df) %>%
  select(-index, -site, -src, -length) %>% 
  dplyr::rename(t = date) %>% 
  drop_na()
  return(SACTN_PN)
}

SACTN_LB <- filter_SACTN(df = "Lamberts Bay") 
SACTN_PN <- filter_SACTN(df = "Port Nolloth") 
SACTN_SB <- filter_SACTN(df = "Saldanha Bay") 
SACTN_SP <- filter_SACTN(df = "Sea Point") 
SACTN_HB <- filter_SACTN(df = "Hout Bay") 
```

The rate of onset of MCS can be determined here

```{r}

#' # Or if one wants to calculate MCSs

MCS_func <- function(df){
  res_clim <- ts2clm(df, climatologyPeriod = c("1974-01-01", "2015-12-31"),
                   pctile = 10)
  return(res_clim)
}

PN_MCS <- MCS_func(df = SACTN_PN)
LB_MCS <- MCS_func(df = SACTN_LB)
SB_MCS <- MCS_func(df = SACTN_SB)
SP_MCS <- MCS_func(df = SACTN_SP)

res_clim <- ts2clm(SACTN_HB, climatologyPeriod = c("1974-01-01", "2005-10-19"), # Climatological period differs to the rest
                   pctile = 10)

## Events
MCS_event <- function(df){
  detect <- detect_event(df, coldSpells = TRUE)
  return(detect)
}

PN_MCS_events <- MCS_func(df = PN_MCS)
LB_MCS_events <- MCS_func(df = LB_MCS)
SB_MCS_events <- MCS_func(df = SB_MCS)
SP_MCS_events <- MCS_func(df = SP_MCS)

HB_MCS_events <- detect_event(res_clim, coldSpells = TRUE) # line 118 -
```

## Upwelling events - 30th percentile used as a threshold to detect upwellling events. 

```{r}
upwell_func <- function(df){
  res_clim <- ts2clm(df, climatologyPeriod = c("1974-01-01", "2015-12-31"),
                   pctile = 30)
  return(res_clim)
}

PN_upwell <- upwell_func(df = SACTN_PN)
LB_upwell <- upwell_func(df = SACTN_LB)
SB_upwell <- upwell_func(df = SACTN_SB)
SP_upwell <- upwell_func(df = SACTN_SP)

res_clim <- ts2clm(SACTN_HB, climatologyPeriod = c("1974-01-01", "2005-10-19"), # Climatological period differs to the rest
                   pctile = 10)

## Events
upwell_event <- function(df){
  detect <- detect_event(df, minDuration = 2, coldSpells = TRUE)
  return(detect)
}

PN_upwell_events <- MCS_func(df = PN_upwell)
LB_upwell_events <- MCS_func(df = LB_upwell)
SB_upwell_events <- MCS_func(df = SB_upwell)
SP_upwell_events <- MCS_func(df = SP_upwell)

HB_upwell_events <- detect_event(res_clim, minDuration = 2, coldSpells = TRUE) # line 1
```











